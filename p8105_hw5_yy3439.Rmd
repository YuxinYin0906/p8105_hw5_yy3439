---
title: "p8105_hw5_yy3439"
output: github_document
date: "2023-11-14"
---
```{r}
library(tidyverse)
library(ggplot2)
library(purrr)
library(broom)
```



## Problem 1

```{r}
homicide_data = read_csv("./data/homicide-data.csv") #import data
```

### Description of the Raw Data

The raw data has 12 columns and 52179 rows. The variables(columns) are comprised of two types: characters and numerical.

### Total Number of homicides and the number of unsolved homicides
```{r}
homicide_data_tidy = homicide_data|>
  mutate(city_state = str_c(city, state, sep = ", ", collapse = NULL))|> #create the city_state variable
  mutate(result = case_when(
    disposition == "Closed without arrest" ~ "unsolved", #create the result variable which indicates whether the case is solved or unsolved
    disposition == "Closed by arrest" ~ "solved",
    disposition == "Open/No arrest" ~ "unsolved"
  ))
```

```{r}
homicides_sum = homicide_data_tidy|>
  group_by(city_state)|>
  summarise(total_homicides = n(),
            unsolved_homicides = sum(result == "unsolved"))
homicides_sum
```

As a result, the data frame contains each city in the U.S. and their corresponding totoal number of homicides as well as total number of unsolved homicides. 

### Conduct `prop.test` on Baltimore

```{r}
Baltimore_hom_total = homicides_sum|>
  filter(city_state == "Baltimore, MD")|>
  pull(total_homicides)
Baltimore_hom_unsolved = homicides_sum|>
  filter(city_state == "Baltimore, MD")|>
  pull(unsolved_homicides)

baltimore_test = prop.test(Baltimore_hom_unsolved, Baltimore_hom_total)
baltimore_test_tidy = broom::tidy(baltimore_test)
```
As a result, the estimated proportion of unsolved homicides in Baltimore is `r baltimore_test_tidy |> pull(estimate)`. In addition, the confidence interval is [`r baltimore_test_tidy |> pull(conf.low)`, `r baltimore_test_tidy |> pull(conf.high)`]. Additionally, the estimated proportion falls between the confidence interval. 

### Conduct the `prop.test` On Each City

```{r}
test = homicides_sum |>
  mutate(
  prop_test = map2(homicides_sum$unsolved_homicides, homicides_sum$total_homicides, \(x, y) prop.test(x = x, n = y)),
  tidy_test = map(prop_test, broom::tidy))|>
  select(-prop_test)|>
  unnest(tidy_test)|>
  select(city_state, estimate, conf.low, conf.high)
test
```

### Visualization

```{r}
test|>
  mutate(city_state = fct_reorder(city_state, estimate))|>
  ggplot(aes(x = city_state, y = estimate))+
  geom_point()+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Problem 2

### Step 1

Ceate a dataframe containing all file names.

```{r}
filenames_data = list.files(path = "data_p2/") #import data
```

### Step 2

Then, we iterate file names and read in data for each subject using `purrr::map` and saving the result as a new variable in the dataframe. Additionally, we add each participant's id as the first entry column. 

```{r}
files_df = map_dfr(filenames_data, ~read_csv(file.path("data_p2/", .)), .id = "id")|>
  mutate(id = as.numeric(id))|>
  bind_rows()
```



### Step 3

Finally, we should tidy the `files_df` data frame and include the control arm and subject ID.

```{r}
files_df_tidy = files_df|>
  mutate(control_arm = case_when(
    id < 11 ~ "Control",
    id >10 ~ "Experiment"
  ),
  subject_id = ifelse(
    id < 11, id, id-10
  )) |>
  pivot_longer(
    cols = starts_with("week"),
    names_to = "week",
    values_to = "values",
    names_prefix = "week_"
  )|>
  select(-id)|>
  relocate(subject_id, control_arm)
```

